machine:
  environment:
    # QUAYIO_ACCESSTOKEN: access token is a hidden env variable
    # QUAYIO_REPO: stackstorm/rpmbuildpack-deps
    # QUAYIO_PULLROBOT: stackstorm+circleci
    # DOCKERFILE_BASE: "https://raw.githubusercontent.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BRANCH}"
    IMAGE: quay.io/stackstorm/rpmbuildpack-deps
    DISTROS: centos6 centos7 fedora22 fedora23
  services:
    - docker

checkout:
  pre:
    - "git clone --depth 1 https://github.com/docker-library/official-images.git ~/official-images"
    - "wget -qO- https://github.com/dennybaa/circle-helpers/raw/master/setup | sh -s"
    # - "wget -qO- https://dennybaa/docker-citools/raw/master/setup | sh -s -- --sudo-pip"

test:
  override:
    - ? |
          step dist in $DISTROS <<'EHD'
            cd $dist
            docker build -t "$IMAGE-curl" curl
            docker build -t "$IMAGE-scm" scm
            docker build -t "$IMAGE" .
            ~/official-images/test/run.sh "$IMAGE"
          EHD
      : parallel: true

# deployment:
#   publish:
#     branch:
#       - master
#     owner: dennybaa
#     commands:
#       - |
#           # Read updated dockerfiles (ordered by variant) and initiate build in quay.io
#           cat ~/updated-dockerfiles | while read dockerfile; do
#             stripped="${dockerfile%/Dockerfile}/"
#             version=${stripped%%/*}; variant=${stripped#*/} && variant=${variant%/};
#             [ -z "$variant" ] && tag="${version}" || tag="${version}-${variant}"
#             url="${DOCKERFILE_BASE}/${dockerfile}"
#             ~/docker-citools/quayio/build.py -r ${QUAYIO_REPO} -t ${tag} -d ${url} -p ${QUAYIO_PULLROBOT}
#           done
